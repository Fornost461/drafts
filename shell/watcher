#!/bin/sh

# watcher - launch video files with some player

## parameters

print_help_at_launch=true
file_browser='spacefm'
video_player='vlc'

dir_root='/home/val/mnt/Data/Downloads/v'
dir_videos_to_play="${dir_root}/unwatched"

if [ -d "${dir_videos_to_play}" ] && [ -n "$(ls -A "${dir_videos_to_play}")" ]; then
# if directory is not empty
    move_videos=true
    dir_moved_videos="${dir_root}/$(date -I)"
else
    dir_videos_to_play="${dir_root}"
    move_videos=false
fi

## code

PROGNAME="watcher"
PROGDIR="$(cd "$(dirname "${0}")" && pwd -P)"

# load libraries
. "${PROGDIR}/_utils/load" || { echo "${PROGNAME}: line ${LINENO}: error code ${?} while sourcing “ ${PROGDIR}/_utils/load ”" >&2 ; exit 1; }

# debug mode
no_video=false
[ "${#}" -gt 0 ] && no_video=true

"${print_help_at_launch}" && _usage

_question()
{
    printf '“ %s ”. Action ? ' "${file}"
    if "${move_videos}"; then
        if "${moved}"; then
            printf '[n]/y/'
        else
            printf '[y]/n/'
        fi
    else
        printf '[n]/'
    fi
    printf '%s\n' 'q/r/d/p/h'
}

_play_vid()
{
    if ! "${no_video}"; then
        "${video_player}" "${file}" 1>/dev/null 2>&1 & disown
    fi
}

_move_video()
{
    if mkdir -vp "${dir_moved_videos}"; then
        mv -vi "${file}" "${dir_moved_videos}" && moved=true
    else
        echo "${PROGNAME}: an error occurred when attempting to create directory ${dir_moved_videos}" >&2
    fi
}

#~ while true
#~ do
# launch up to 20 files
"${PROGDIR}/pick_file" 20 "${dir_videos_to_play}" | while read file
do
    [ -e "${file}" ] || break   # check if user removed file
    dir="$(dirname "${file}")"
    moved=false
    _play_vid
    reask=true
    while "${reask}"
    do
        _question
        read ans < /dev/tty
        case "${ans}" in
            p|P)    # file browser
                [ -d "${dir}" ] && "${file_browser}" "${dir}" >/dev/null 2>&1 &
                ;;
            r|R)    # replay
                _play_vid
                ;;
            d|D)    # delete file
                rm -v "${file}" && moved=true
                ;;
            n|N)    # skip next actions
                reask=false
                ;;
            q|Q)    # exit
                echo 'Quitting.'
                exit 0
                ;;
            y|Y)   # move file
                
                "${move_videos}" && _move_video
                ;;
            '')
                if "${move_videos}" && ! "${moved}"; then
                    _move_video
                else
                    reask=false
                fi
                ;;
            *)    # print help
                printf '%s\n' 'Invalid command.'
                _usage
                ;;
        esac
    done
done
